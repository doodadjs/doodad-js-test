<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="../../doodad-js-test/units/Test.css" />
</head>
<body>
    <script async src="../../doodad-js/doodad-js.js"></script>
    <script async src="../../doodad-js/lib/uuid/uuid.min.js"></script>
    <script async src="../../lib/sax/sax.js"></script>
    <script src="../../lib/moment/moment.min.js"></script>
    <script src="../../lib/moment-timezone/moment-timezone.min.js"></script>

    <!--IE8 <script>
        // <PRB> "es6-promise" needs "Array.isArray"
        if (!Array.isArray) {
            Array.isArray = function(obj) {
                return Object.prototype.toString.call(obj) === '[object Array]';
            };
        };
    </script>-->
    <script src="../../lib/es6-promise/es6-promise.min.js"></script>

    <script>
			(function() {
				"use strict";

				var	__prevOnLoad__ = window.onload;
				window.onload = function testWindowOnLoad(ev) {
					if (__prevOnLoad__) {
						__prevOnLoad__.call(this, ev);
					};

					const global = window;

					const options = {};

					options['Doodad.Modules'] = {
						modulesUri: '../..',
					};

					options['Doodad.Tools.Dates.Moment'] = {
					    dataUri: '/app/lib/moment-timezone/data/',
					};

				    global.createRoot(null, options)
					    .then(function(root) {
					        global.DD_ROOT = root; // For tests
					        return root;
					    })
                        .then(function (root) {
                            const doodad = root.Doodad,
						        modules = doodad.Modules;

                            return modules.load([
                                {
                                    module: 'doodad-js',
                                    path: 'doodad-js_tests.js'
                                },
                                {
                                    module: 'doodad-js-unicode',
                                },
                                {
                                    module: 'doodad-js-locale',
                                },
                                {
                                    module: 'doodad-js-dates',
                                },
                                {
                                    module: 'doodad-js-io',
                                },
                                {
                                    module: 'doodad-js-safeeval',
                                },
                                {
                                    module: 'doodad-js-safeeval',
                                    path: 'doodad-js-safeeval_tests.js'
                                },
                                {
                                    module: 'doodad-js-test',
                                },
                            ], options);
                        })
				        .then(function (root) {
				            const doodad = root.Doodad,
                                tools = doodad.Tools,
                                test = doodad.Test,
				                clientIO = doodad.Client.IO;

				            const args = tools.getCurrentLocation().args,
			                    unitName = args.get('unit');

				            test.setOutput(new clientIO.DomOutputStream({ flushMode: 'manual' }));
				            return test.run({name: unitName});
				        })
				        .catch(function (err) {
							alert(err);
						});
				};
			}).call((typeof global !== 'undefined') ? global : ((typeof window !== 'undefined') ? window : this));
    </script>
</body>
</html>
